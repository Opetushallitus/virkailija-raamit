
sudo: required

language: java

jdk:
- openjdk8

services:
- docker

cache:
  directories:
  - $HOME/.m2

env:
  global:
  # AWS_ACCESS_KEY_ID
  - secure: "BKtpaewxK05bj6d/SxP06NsqZVJpd1h6PhpqpRVjL+D9NnMPlc/unqD2TjT08yihzJhvhrbFq5elAnb21xUE+5scY7bAJAyP/3RwXTuRzibDvnBxYqbNyMVqqzVocSa65pFhEchp/RpTXEVx7i6j3caAQlWZzXKPwN7za+u6JVE="
  # AWS_SECRET_ACCESS_KEY
  - secure: "M6/8B1uZh7gVy5VU0le6WEtjU0IgW6qZobVS/jjrQN8UBwyBJG1sf/Uc5nbj46XxOFnkZX32jyizo2WdV44ZS8GRXrGKTPI4s9X251ObthyxT53aL45QRfLZhZK1QdvGIvz5bO7wUDHeWI6SsO6yonqdltkYz8qmzzs7v7VP/VI="
  - CI: false

install:
- git clone https://github.com/Opetushallitus/ci-tools.git
- source ci-tools/common/setup-tools.sh
- export ARTIFACT_NAME="virkailija-raamit"

script:
- mvn clean package -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

- mv -v target/virkailija-raamit-*.war $DOCKER_BUILD_DIR/artifact/$ARTIFACT_NAME.war
- cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

- export BASE_IMAGE="baseimage-war-openjdk8:master"
- ./ci-tools/common/pull-image.sh
- ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
- provider: script
  script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
  on:
    all_branches: true
